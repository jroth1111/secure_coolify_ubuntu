version: 1

# Contract line format:
#   "<ID>|<workflow>|<script-path>|<script-anchor>|<doc-path>|<doc-anchor>|<test-file>::<exact test title>[;<test-file>::<exact test title>...]"
steps:
  - "HB-01|bootstrap|bootstrap_hardening.sh|validate_inputs|docs/bootstrap_functionality_test_matrix.md|HB-01|tests/unit/test_functions.bats::validate_inputs: valid inputs pass;tests/unit/test_functions.bats::ensure_packages: installs only missing packages via apt-get"
  - "HB-02|bootstrap|bootstrap_hardening.sh|ensure_timesync|docs/bootstrap_functionality_test_matrix.md|HB-02|tests/integration/test_dry_run.bats::dry-run: logs every major phase;tests/integration/test_full_run.bats::timesync: NTP is active when supported by container runtime"
  - "HB-03|bootstrap|bootstrap_hardening.sh|configure_swap|docs/bootstrap_functionality_test_matrix.md|HB-03|tests/integration/test_full_run.bats::swap: swap is active;tests/integration/test_dry_run.bats::dry-run: does not create swap file"
  - "HB-04|bootstrap|bootstrap_hardening.sh|disable_unused_services|docs/bootstrap_functionality_test_matrix.md|HB-04|tests/integration/test_full_run.bats::services: rpcbind masked or not found"
  - "HB-05|bootstrap|bootstrap_hardening.sh|configure_banner|docs/bootstrap_functionality_test_matrix.md|HB-05|tests/integration/test_full_run.bats::banner: /etc/issue.net contains AUTHORIZED"
  - "HB-06|bootstrap|bootstrap_hardening.sh|ensure_admin_access|docs/bootstrap_functionality_test_matrix.md|HB-06|tests/integration/test_full_run.bats::admin: user exists;tests/integration/test_full_run.bats::ssh: sshd -T shows passwordauthentication no"
  - "HB-07|bootstrap|bootstrap_hardening.sh|configure_auditd|docs/bootstrap_functionality_test_matrix.md|HB-07|tests/integration/test_full_run.bats::audit: rules file exists"
  - "HB-08|bootstrap|bootstrap_hardening.sh|configure_sysctl|docs/bootstrap_functionality_test_matrix.md|HB-08|tests/integration/test_full_run.bats::sysctl: tcp_syncookies is 1"
  - "HB-09|bootstrap|bootstrap_hardening.sh|configure_ufw|docs/bootstrap_functionality_test_matrix.md|HB-09|tests/integration/test_full_run.bats::ufw: is active;tests/integration/test_full_tunnel.bats::tunnel: no WAN port 80 UFW rule"
  - "HB-10|bootstrap|bootstrap_hardening.sh|configure_docker_daemon|docs/bootstrap_functionality_test_matrix.md|HB-10|tests/integration/test_full_run.bats::docker-daemon: log-driver is json-file"
  - "HB-11|bootstrap|bootstrap_hardening.sh|configure_docker_user|docs/bootstrap_functionality_test_matrix.md|HB-11|tests/integration/test_full_run.bats::iptables: DOCKER-USER chain exists;tests/integration/test_full_tunnel.bats::tunnel: DOCKER-USER chain has no wan-web ACCEPT rule"
  - "HB-12|bootstrap|bootstrap_hardening.sh|configure_fail2ban|docs/bootstrap_functionality_test_matrix.md|HB-12|tests/integration/test_full_run.bats::fail2ban: service is active"
  - "HB-13|bootstrap|bootstrap_hardening.sh|configure_journald|docs/bootstrap_functionality_test_matrix.md|HB-13|tests/integration/test_full_run.bats::journald: drop-in has Storage=persistent"
  - "HB-14|bootstrap|bootstrap_hardening.sh|configure_unattended_upgrades|docs/bootstrap_functionality_test_matrix.md|HB-14|tests/integration/test_full_run.bats::upgrades: auto-upgrade config present"
  - "HB-15|bootstrap|bootstrap_hardening.sh|run_post_checks|docs/bootstrap_functionality_test_matrix.md|HB-15|tests/integration/test_full_run.bats::state: JSON report written;tests/integration/test_validate_script.bats::validate: exits 0 after hardening bootstrap"

  - "DEP-01|deploy|deploy.sh|preflight()|docs/deploy_setup_functionality_test_matrix.md|DEP-01|tests/unit/test_deploy_workflow_contract.bats::deploy: preflight phase marker exists"
  - "DEP-02|deploy|deploy.sh|phase1_upload_harden()|docs/deploy_setup_functionality_test_matrix.md|DEP-02|tests/unit/test_deploy_workflow_contract.bats::deploy: phase1 upload+harden marker exists"
  - "DEP-03|deploy|deploy.sh|bootstrap_hardening.sh --env-file /root/deploy.env --install-tailscale --force|docs/deploy_setup_functionality_test_matrix.md|DEP-03|tests/unit/test_deploy_workflow_contract.bats::deploy: hardening invocation uses env-file and tailscale install"
  - "DEP-04|deploy|deploy.sh|Gate A: Testing SSH admin@|docs/deploy_setup_functionality_test_matrix.md|DEP-04|tests/unit/test_deploy_workflow_contract.bats::deploy: gate A checks admin SSH on tailscale"
  - "DEP-05|deploy|deploy.sh|Gate B: whoami=|docs/deploy_setup_functionality_test_matrix.md|DEP-05|tests/unit/test_deploy_workflow_contract.bats::deploy: gate B verifies admin identity"
  - "DEP-06|deploy|deploy.sh|Gate C: Running validate_hardening.sh...|docs/deploy_setup_functionality_test_matrix.md|DEP-06|tests/unit/test_deploy_workflow_contract.bats::deploy: gate C runs validate_hardening.sh json"
  - "DEP-07|deploy|deploy.sh|Gate D: Verify DOCKER-USER rules|docs/deploy_setup_functionality_test_matrix.md|DEP-07|tests/unit/test_deploy_workflow_contract.bats::deploy: gate D validates service active and managed rules"
  - "DEP-08|deploy|deploy.sh|phase4_binding_dns()|docs/deploy_setup_functionality_test_matrix.md|DEP-08|tests/unit/test_deploy_workflow_contract.bats::deploy: phase4 binding+dns marker exists"
  - "DEP-09|deploy|deploy.sh|Gate E: Checking dashboard accessibility...|docs/deploy_setup_functionality_test_matrix.md|DEP-09|tests/unit/test_deploy_workflow_contract.bats::deploy: gate E fails when exposure checks do not pass"
  - "DEP-10|deploy|deploy.sh|Running final validate_hardening.sh...|docs/deploy_setup_functionality_test_matrix.md|DEP-10|tests/unit/test_deploy_workflow_contract.bats::deploy: final validation is executed"

  - "SET-01|setup|setup.sh|preflight()|docs/deploy_setup_functionality_test_matrix.md|SET-01|tests/unit/test_setup_workflow_contract.bats::setup: preflight phase marker exists"
  - "SET-02|setup|setup.sh|phase1_harden()|docs/deploy_setup_functionality_test_matrix.md|SET-02|tests/unit/test_setup_workflow_contract.bats::setup: phase1 harden marker exists"
  - "SET-03|setup|setup.sh|Gate A: Operator verifies SSH from laptop|docs/deploy_setup_functionality_test_matrix.md|SET-03|tests/unit/test_setup_workflow_contract.bats::setup: gate A requires operator laptop verification"
  - "SET-04|setup|setup.sh|Gate B: Admin user|docs/deploy_setup_functionality_test_matrix.md|SET-04|tests/unit/test_setup_workflow_contract.bats::setup: gate B verifies admin user home and ssh directory"
  - "SET-05|setup|setup.sh|Gate C: Running validate_hardening.sh...|docs/deploy_setup_functionality_test_matrix.md|SET-05|tests/unit/test_setup_workflow_contract.bats::setup: gate C runs validate_hardening.sh json"
  - "SET-06|setup|setup.sh|Gate D: Verify DOCKER-USER rules|docs/deploy_setup_functionality_test_matrix.md|SET-06|tests/unit/test_setup_workflow_contract.bats::setup: gate D validates service active and managed rules"
  - "SET-07|setup|setup.sh|phase4_binding_dns()|docs/deploy_setup_functionality_test_matrix.md|SET-07|tests/unit/test_setup_workflow_contract.bats::setup: phase4 binding+dns marker exists"
  - "SET-08|setup|setup.sh|Gate E: Operator verifies from laptop|docs/deploy_setup_functionality_test_matrix.md|SET-08|tests/unit/test_setup_workflow_contract.bats::setup: gate E requires operator laptop verification"
  - "SET-09|setup|setup.sh|Running final validate_hardening.sh...|docs/deploy_setup_functionality_test_matrix.md|SET-09|tests/unit/test_setup_workflow_contract.bats::setup: final validation is executed"

consistency_checks:
  - "README.md|applies **15 security controls**"
  - "README.md|`--tunnel-mode` / `--mode tunnel`"
  - "README.md|`--tunnel-mode` | `false` |"
  - "HARDENING_PROCEDURE.md|applies 15 baseline controls in this order"
  - "docs/DEPLOYMENT_RUNBOOK.md|Automated scripts (`deploy.sh`/`setup.sh`) use this gate mapping"
  - "docs/testing.md|docs/deploy_setup_functionality_test_matrix.md"
  - "docs/testing.md|docs/workflow_contract.yaml"
